<!DOCTYPE html>
<html>
    <head>
        <title>Basic Blog</title>
        <meta charset="UTF-8">
        <script>
            
            /* Actions and API calls */

            const getPosts = () => {
                fetch('http://localhost:8080/api/v1/post/', {
                    headers: {
                        "Authorization": window.sessionStorage.getItem("token"),
                    }
                }).then(rawResponse => {
                    return rawResponse.json()
                }).then(displayPosts).catch(err => {
                    console.error(err)
                })
            }

            const getPost = postId => {
                fetch(`http://localhost:8080/api/v1/post/${postId}`, {
                    headers: {
                        "Authorization": window.sessionStorage.getItem("token"),
                    }
                }).then(rawResponse => {
                    return rawResponse.json()
                }).then(displayPost).catch(err => {
                    console.error(err)
                })
            }

            const newPost = () => {
                const postData = JSON.stringify({
                    title: document.getElementById("newTitle").value,
                    body: document.getElementById("newBody").value,
                })
                fetch(`http://localhost:8080/api/v1/post/`, {
                    method: 'POST',
                    headers: {
                        "Authorization": window.sessionStorage.getItem("token"),
                    },
                    body: postData,
                }).then(resp => {
                    if (resp.status === 401) {
                        flashMessage("Please log in to post", "error")
                        show("login")
                        return
                    }
                    return resp.json()
                }).then(displayPost).catch(err => {
                    console.error(err)
                })
            }

            const newComment = postId => {
                const postData = JSON.stringify({
                    commenter: document.getElementById("newCommentCommenter").value,
                    body: document.getElementById("newCommentBody").value,
                })
                fetch(`http://localhost:8080/api/v1/post/${postId}/comment`, {
                    method: 'POST',
                    headers: {
                        "Authorization": window.sessionStorage.getItem("token"),
                    },
                    body: postData,
                }).then(rawResponse => {
                    return rawResponse.json()
                }).then(() => {
                    getPost(postId)
                }).catch(err => {
                    console.error(err)
                })
            }

            const deletePost = postId => {
                fetch(`http://localhost:8080/api/v1/post/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        "Authorization": window.sessionStorage.getItem("token"),
                    },
                }).then(response => {
                    if (response.status === 200 || response.status === 204) {
                        flashMessage("Post deleted")
                        getPosts()
                        show("posts")
                    } else {
                        flashMessage("Error deleting post", "error")
                    }
                }).catch(err => {
                    console.error(err)
                })
            }

            const restorePost = postId => {
                fetch(`http://localhost:8080/api/v1/post/${postId}`, {
                    method: 'POST',
                    headers: {
                        "Authorization": window.sessionStorage.getItem("token"),
                    },
                    body: JSON.stringify({
                        deleted: false
                    })
                }).then(response => {
                    if (response.status === 200 || response.status === 204) {
                        flashMessage("Post restored")
                        getPosts()
                        show("posts")
                    } else {
                        flashMessage("Error restoring post", "error")
                    }
                }).catch(err => {
                    console.error(err)
                })
            }

            /* Blog post view helpers */

            const displayPosts = postData => {
                let posts = []
                let deleted = []
                postData.forEach(post => {
                    if (!post.deleted) {
                        posts.push(formatPostListItem(post))
                    } else {
                        deleted.push(formatPostListItem(post))
                    }
                })
                document.getElementById("postList").innerHTML = `<ol>${posts.join("")}</ol>`

                deletedHtml = deleted.length > 0 ? `<h4>Deleted Posts</h4><ol>${deleted.join("")}</ol>` : ""
                document.getElementById("deletedPosts").innerHTML = deletedHtml
            }

            const formatPostListItem = post => {
                return `<li><a href="#" onclick="getPost(${post.id}); show('post');">${post.title} by ${post.author} posted on ${post.createdTime}</a></li>`
            }

            const displayPost = post => {
                // Display post and data
                let html = `<h3>${post.title}</h3>
                            <div>By ${post.author} | posted ${post.createdTime}</div>
                            <div>${post.body}</div>`

                // Display author edit controls
                if (isLoggedIn()) {
                    deleteAction = post.deleted ? `<button onclick="restorePost(${post.id});">Restore</button>` : `<button onclick="deletePost(${post.id});">Delete</button>`
                    html += `${deleteAction}<button onclick="alert('not implemented')">Edit</button>`
                }
                    
                // Display new comment form
                if (!post.deleted) {
                    html += `<h4>New Comment</h4>
                    <form>
                        <input type="text" id="newCommentCommenter" placeholder="Your Name"></input><br/>
                        <textarea id="newCommentBody" placeholder="Comment"></textarea>
                        <button onclick="newComment(${post.id})">Comment</button>
                    </form>`
                }

                // Display list of comments
                if (post.comments && post.comments.length > 0) {
                    comments = []
                    post.comments.forEach(comment => {
                        comments.push(`<li>Comment by ${comment.commenter} on ${comment.createdTime}
                                <p>${comment.body}</p>
                                </li>`)
                    })
                    html += `<h4>Comments</h4><ol>${comments.join("")}</ol>`
                }
                const el = document.getElementById("currentPost")
                el.innerHTML = html
            }

            /* Login/logout */

            const login = () => {
                const postData = JSON.stringify({
                    user: document.getElementById("loginUsername").value,
                    password: document.getElementById("loginPassword").value,
                })
                fetch(`http://localhost:8080/api/v1/authenticate`, {
                    method: 'POST',
                    body: postData,
                }).then(resp => {
                    if (resp.status === 401) {
                        flashMessage("Invalid credentials", "error")
                        return
                    }
                    return resp.text()
                }).then(authenticationData => {
                    if (authenticationData) {
                        window.sessionStorage.setItem("token", authenticationData)
                        flashMessage("Logged in!")
                        getPosts()
                        show("posts")
                    }
                }).catch(err => {
                    console.error(err)
                })
            }

            const logout = () => {
                window.sessionStorage.removeItem("token")
                flashMessage("Logged out")
                show("posts")
            }

            const isLoggedIn = () => {
                return !!window.sessionStorage.getItem("token")
            }

            /* Flash messages */

            const flashMessage = (msg, id = "message") => {
                const el = document.getElementById(id)
                el.innerHTML = msg
                setTimeout(() => el.innerHTML = "", 5000)
            }

            /* Section/route visibility and DOM element rendering logic */

            const sections = [
                "posts",
                "post",
                "newPost",
                "login",
            ]

            let currentSection = "posts"

            const show = showSection => {
                currentSection = showSection
                render()
            }

            const render = () => {
                sections.forEach(section => {
                    document.getElementById(section).style.display = section === currentSection ? "block" : "none"
                })

                Array.from(document.getElementsByClassName("anonymous")).forEach(el => {
                    el.style.display = isLoggedIn() ? "none" : "inline"
                })
                Array.from(document.getElementsByClassName("authenticated")).forEach(el => {
                    el.style.display = isLoggedIn() ? "inline" : "none"
                })
            }
        </script>
    </head>
    <body onload="getPosts(); show('posts');">
        <nav>
            <a href="#" onclick="getPosts(); show('posts');">Posts</a> | <span class="authenticated"><a href="#"  onclick="show('newPost')">New Post</a> | </span><span class="anonymous"><a href="#" onclick="show('login')">Login</a></span> <span class="authenticated"><a href="#" onclick="logout()">Logout</a></span>
        </nav>
        <span id="error" style="color:red"></span><br/>
        <span id="message" style="color:green"></span><br/>
        <section id="posts">
            <h1>Blog</h1>
            <div id="postList"></div>
            <div class="authenticated" id="deletedPosts"></div>
        </section>
        <section id="post">
            <h2>Current Post</h2>
            <div id="currentPost"></div>
        </section>
        <section id="newPost">
            <h2>New Post</h2>
            <form>
                <input type="text" id="newTitle" placeholder="Post Title"></input><br/>
                <textarea id="newBody" placeholder="Post Body"></textarea>
                <button onclick="newPost(); show('post');">Save</button>
            </form>
        </section>
        <section id="login">
            <h2>Login</h2>
            <form>
                <input type="text" id="loginUsername" placeholder="Username"></input><br/>
                <input type="password" id="loginPassword" placeholder="Password"></form>
                <button onclick="login()">Login</button>
            </form>
        </section>
    </body>
</html>