<!DOCTYPE html>
<html>
    <head>
        <title>Basic Blog</title>
        <meta charset="UTF-8">
        <script>
            const getPosts = () => {
                fetch('http://localhost:8080/api/v1/post/').then(rawResponse => {
                    return rawResponse.json()
                }).then(responseJson => {
                    let html = "<ul>"
                    responseJson.forEach(post => {
                        html += `<li><a href="#" onclick="getPost(${post.id}); show('post');">${post.title} by ${post.author} posted on ${post.createdTime}</a></li>`
                    })
                    html += "</ul>"
                    const el = document.getElementById("postList")
                    el.innerHTML = html
                }).catch(err => {
                    console.error(err)
                })
            }

            const getPost = postId => {
                fetch(`http://localhost:8080/api/v1/post/${postId}`).then(rawResponse => {
                    return rawResponse.json()
                }).then(displayPost).catch(err => {
                    console.error(err)
                })
            }

            const newPost = () => {
                const postData = JSON.stringify({
                    title: document.getElementById("newTitle").value,
                    headers: {
                        "Authorization": window.sessionStorage.getItem("token"),
                    },
                    body: document.getElementById("newBody").value,
                })
                fetch(`http://localhost:8080/api/v1/post/`, {
                    method: 'POST',
                    body: postData,
                }).then(resp => {
                    if (resp.status === 401) {
                        flashMessage("Please log in to post", "error")
                        show("login")
                        return
                    }
                    return resp.json()
                }).then(displayPost).catch(err => {
                    console.error(err)
                })
            }

            const newComment = () => {
                const postID = document.getElementById("currentPostId").value
                const postData = JSON.stringify({
                    commenter: document.getElementById("newCommentCommenter").value,
                    body: document.getElementById("newCommentBody").value,
                })
                fetch(`http://localhost:8080/api/v1/post/${postID}/comment`, {
                    method: 'POST',
                    body: postData,
                }).then(rawResponse => {
                    return rawResponse.json()
                }).then(() => {
                    getPost(postID)
                }).catch(err => {
                    console.error(err)
                })
            }

            const displayPost = post => {
                let html = `<h3>${post.title}</h3>
                            <input type="hidden" id="currentPostId" value="${post.id}" />
                            <div>By ${post.author} | posted ${post.createdTime}</div>
                            <div>${post.body}</div>
                            `
                if (post.comments && post.comments.length > 0) {
                    html += "<h4>Comments</h4><ol>"
                    post.comments.forEach(comment => {
                        html += `<li>Comment by ${comment.commenter} on ${comment.createdTime}
                                <p>${comment.body}</p>
                                </li>`
                    })
                    html += "</ol>"
                }
                const el = document.getElementById("currentPost")
                el.innerHTML = html
            }

            const login = () => {
                const postData = JSON.stringify({
                    user: document.getElementById("loginUsername").value,
                    password: document.getElementById("loginPassword").value,
                })
                fetch(`http://localhost:8080/api/v1/authenticate`, {
                    method: 'POST',
                    body: postData,
                }).then(resp => {
                    if (resp.status === 401) {
                        flashMessage("Invalid credentials", "error")
                        return
                    }
                    return resp.text()
                }).then(authenticationData => {
                    if (authenticationData) {
                        window.sessionStorage.setItem("token", authenticationData)
                        flashMessage("Logged in!")
                        show("newPost")
                    }
                }).catch(err => {
                    console.error(err)
                })
            }

            const flashMessage = (msg, id = "message") => {
                const el = document.getElementById(id)
                el.innerHTML = msg
                setTimeout(() => el.innerHTML = "", 5000)
            }

            const logout = () => {
                window.sessionStorage.removeItem("token")
                flashMessage("Logged out")
                show("posts")
            }

            const sections = [
                "posts",
                "post",
                "newPost",
                "login",
            ]

            let currentSection = "posts"

            const show = showSection => {
                currentSection = showSection
                render()
            }

            const render = () => {
                sections.forEach(section => {
                    document.getElementById(section).style.display = section === currentSection ? "block" : "none"
                })

                const loggedin = !!window.sessionStorage.getItem("token")
                Array.from(document.getElementsByClassName("anonymous")).forEach(el => {
                    el.style.display = loggedin ? "none" : "inline"
                })
                Array.from(document.getElementsByClassName("authenticated")).forEach(el => {
                    el.style.display = loggedin ? "inline" : "none"
                })
            }
        </script>
    </head>
    <body onload="getPosts(); show('posts');">
        <nav>
            <a href="#" onclick="getPosts(); show('posts');">Posts</a> | <span class="authenticated"><a href="#"  onclick="show('newPost')">New Post</a> | </span><span class="anonymous"><a href="#" onclick="show('login')">Login</a></span> <span class="authenticated"><a href="#" onclick="logout()">Logout</a></span>
        </nav>
        <span id="error" style="color:red"></span><br/>
        <span id="message" style="color:green"></span><br/>
        <section id="posts">
            <h1>Blog</h1>
            <div id="postList"></div>
        </section>
        <section id="post">
            <h2>Current Post</h2>
            <div id="currentPost"></div>
            <h4>New Comment</h4>
            <form>
                <input type="text" id="newCommentCommenter" placeholder="Your Name"></input><br/>
                <textarea id="newCommentBody" placeholder="Comment"></textarea>
                <button onclick="newComment()">Comment</button>
            </form>
        </section>
        <section id="newPost">
            <h2>New Post</h2>
            <form>
                <input type="text" id="newTitle" placeholder="Post Title"></input><br/>
                <textarea id="newBody" placeholder="Post Body"></textarea>
                <button onclick="newPost(); show('post');">Save</button>
            </form>
        </section>
        <section id="login">
            <h2>Login</h2>
            <form>
                <input type="text" id="loginUsername" placeholder="Username"></input><br/>
                <input type="password" id="loginPassword" placeholder="Password"></form>
                <button onclick="login()">Login</button>
            </form>
        </section>
    </body>
</html>